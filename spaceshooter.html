<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Celestial Vanguard: Boss Rush</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        /* --- CORE STYLES --- */
        body {
            margin: 0;
            background-color: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            touch-action: none;
            font-family: 'Press Start 2P', cursive;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 540px;
            max-height: 960px;
            background: #000;
            overflow: hidden;
            box-shadow: 0 0 80px rgba(0, 229, 255, 0.1);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        /* --- FX --- */
        .scanlines {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.15) 50%, rgba(0,0,0,0.15));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
            opacity: 0.6;
        }
        
        .glow-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 30%, #000 110%);
            pointer-events: none;
            z-index: 11;
        }

        /* --- UI --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .screen {
            pointer-events: auto;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s ease;
        }

        .screen.active { display: flex; }

        h1 {
            font-size: 34px;
            line-height: 1.4;
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
            color: #fff;
            text-shadow: 0 0 20px #00e5ff;
        }

        #game-over-screen h1 { text-shadow: 0 0 20px #ff0055; color: #ff0055; }

        .subtitle {
            font-size: 12px;
            color: #fff;
            margin-bottom: 60px;
            letter-spacing: 4px;
            text-transform: uppercase;
            opacity: 0.8;
            animation: pulse 2s infinite ease-in-out;
        }

        .score-display {
            font-size: 16px;
            color: #ffeb3b;
            margin: 30px 0;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(255, 235, 59, 0.4);
        }

        button {
            background: transparent;
            border: none;
            font-family: 'Press Start 2P', cursive;
            font-size: 18px;
            color: #fff;
            padding: 20px 40px;
            margin-top: 10px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s;
            position: relative;
        }

        button::after {
            content: '';
            position: absolute;
            bottom: 10px; left: 50%; width: 0%; height: 2px;
            background: #00e5ff;
            box-shadow: 0 0 10px #00e5ff;
            transition: all 0.2s ease;
            transform: translateX(-50%);
        }

        button:active { color: #00e5ff; transform: scale(0.95); }
        button:active::after { width: 60%; }

        .footer {
            position: absolute;
            bottom: 40px;
            color: rgba(255, 255, 255, 0.2);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div class="scanlines"></div>
        <div class="glow-overlay"></div>

        <div id="ui-layer">
            <div id="start-screen" class="screen active">
                <h1>CELESTIAL<br>VANGUARD</h1>
                <p class="subtitle">BOSS RUSH MODE</p>
                <div class="score-display" id="start-last-score">LAST RUN: 0</div>
                <button onclick="initGame()">ENGAGE</button>
                <div class="footer">Made by RTHKH</div>
            </div>

            <div id="game-over-screen" class="screen">
                <h1>MISSION<br>FAILED</h1>
                <div class="score-display" id="final-score">SCORE: 0</div>
                <button onclick="initGame()">RETRY</button>
                <button style="font-size: 12px; margin-top:0; opacity: 0.6;" onclick="showMainMenu()">MENU</button>
                <div class="footer">Made by RTHKH</div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- CONFIG ---
        const GAME_WIDTH = 540;
        const GAME_HEIGHT = 960;
        const PIXEL_SCALE = 3; 
        
        // --- SPRITES (15x15) ---
        const SPRITE_PLAYER = [
            "000000010000000", "000000121000000", "000001121100000", "000001222100000",
            "000011222110000", "000111222111000", "000111010111000", "001110121011100",
            "011111121111110", "111011121110111", "110011111110011", "110001010100011",
            "100001010100001", "100000010000001", "100000000000001"
        ];

        const SPRITE_ENEMY_1 = [
            "000000111000000", "000011121110000", "000111121111000", "001110111011100",
            "011100121001110", "111000111000111", "110000010000011", "100000010000001",
            "000000010000000"
        ];

        const SPRITE_ENEMY_2 = [
            "000000010000000", "000000111000000", "000001121100000", "000011111110000",
            "000110111011000", "001100121001100", "011000111000110", "110000010000011"
        ];

        // --- BOSS MAPS (19x19) ---
        const BOSS_1_MAP = [ // TITAN (Tank)
            "0000000011100000000", "0000001112111000000", "0000111111111110000",
            "0001112221222111000", "0011122221222211100", "0111111111111111110",
            "1112110011100112111", "1111100111110011111", "1111000012100001111",
            "0110000012100000110", "0100000011100000010"
        ];
        const BOSS_2_MAP = [ // WIDOW (Spikey)
            "1000000001000000001", "0100000012100000010", "0010000111110000100",
            "0001001122211001000", "0000111111111110000", "0000112112112110000",
            "0001100011100011000", "0011000101010001100", "0100000001000000010"
        ];
        const BOSS_3_MAP = [ // CORE (Orb)
            "0000000011100000000", "0000001122211000000", "0000011221221100000",
            "0000112211122110000", "0001121112111211000", "0000112211122110000",
            "0000011221221100000", "0000001122211000000", "0000000011100000000"
        ];
        const BOSS_4_MAP = [ // HIVE (Carrier)
            "00111111111111100", "01111211111211110", "11111111111111111", 
            "11000111111100011", "11000101110100011", "01111101010111110", 
            "00011101010111000", "00001000100010000"
        ];
        const BOSS_5_MAP = [ // PHANTOM (Stealth)
            "0000000001000000000", "0000000012100000000", "0000000112110000000",
            "0000001112111000000", "0000011121211100000", "0000111111111110000",
            "0011100011100011100", "0111000011100001110", "1110000012100000111",
            "1100000001000000011"
        ];
        const BOSS_6_MAP = [ // LANCER (Vertical)
            "0000000011100000000", "0000000012100000000", "0000000012100000000",
            "0000000112110000000", "0000001111111000000", "0000011122211100000",
            "0000111111111110000", "0001110111110111000", "0011100111110011100",
            "0011000012100001100"
        ];
        const BOSS_7_MAP = [ // HELIX (Wide)
            "1000000000000000001", "1100000000000000011", "0110000011100000110",
            "0011000112110001100", "0001101111111011000", "0000111112111110000",
            "0000011111111100000", "0000001121211000000", "0000000111110000000"
        ];

        // --- VARS ---
        let gameState = 'MENU';
        let score = 0;
        let frames = 0;
        let input = { x: 0, y: 0, active: false };
        let nextBossScore = 3000; // Frequent Bosses
        let bossLevel = 0;
        let screenShake = 0;

        let entities = {
            player: null,
            bullets: [],
            enemies: [],
            particles: [],
            stars: [],
            boss: null
        };

        // --- SYSTEM ---
        function resize() {
            let scale = Math.min(window.innerWidth / GAME_WIDTH, window.innerHeight / GAME_HEIGHT);
            canvas.width = GAME_WIDTH;
            canvas.height = GAME_HEIGHT;
            ctx.imageSmoothingEnabled = false;
        }
        window.addEventListener('resize', resize);
        resize();

        function handleInput(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            let cx = e.touches ? e.touches[0].clientX : e.clientX;
            let cy = e.touches ? e.touches[0].clientY : e.clientY;
            
            input.x = (cx - rect.left) * scaleX;
            input.y = ((cy - rect.top) * scaleY) - 100; // 100px Offset
            input.active = true;
        }
        
        ['mousedown', 'touchstart'].forEach(e => canvas.addEventListener(e, (ev) => { input.active = true; handleInput(ev); }, {passive:false}));
        ['mousemove', 'touchmove'].forEach(e => canvas.addEventListener(e, (ev) => { if(input.active) handleInput(ev); }, {passive:false}));
        ['mouseup', 'touchend'].forEach(e => canvas.addEventListener(e, () => input.active = false));

        // --- RENDERER (Seamless) ---
        function drawSprite(map, x, y, mainColor, accentColor, scale = PIXEL_SCALE) {
            for(let r=0; r<map.length; r++){
                for(let c=0; c<map[r].length; c++){
                    let val = map[r][c];
                    if(val !== "0") {
                        ctx.fillStyle = (val === "2") ? accentColor : mainColor;
                        ctx.fillRect(Math.floor(x + c*scale), Math.floor(y + r*scale), scale + 0.5, scale + 0.5);
                    }
                }
            }
        }

        // --- CLASSES ---
        class Player {
            constructor() {
                this.w = 15 * PIXEL_SCALE;
                this.h = 15 * PIXEL_SCALE;
                this.x = GAME_WIDTH/2 - this.w/2;
                this.y = GAME_HEIGHT - 150;
            }
            update() {
                if (input.active) {
                    this.x += (input.x - this.x - this.w/2) * 0.25;
                    this.y += (input.y - this.y - this.h/2) * 0.25;

                    if(frames % 6 === 0) { 
                        entities.bullets.push(new Bullet(this.x + 4, this.y + 10));
                        entities.bullets.push(new Bullet(this.x + this.w - 10, this.y + 10));
                    }
                }
                
                let minY = GAME_HEIGHT * 0.35; 
                if(this.y < minY) this.y = minY;
                if(this.y > GAME_HEIGHT - this.h) this.y = GAME_HEIGHT - this.h;
                if(this.x < 0) this.x = 0; 
                if(this.x > GAME_WIDTH - this.w) this.x = GAME_WIDTH - this.w;
            }
            draw() {
                drawSprite(SPRITE_PLAYER, this.x, this.y, '#00e5ff', '#fff');
                if(frames % 4 === 0) {
                    entities.particles.push(new Particle(this.x + 10, this.y + this.h, '#00e5ff', 3));
                    entities.particles.push(new Particle(this.x + this.w - 10, this.y + this.h, '#00e5ff', 3));
                }
            }
        }

        class Boss {
            constructor(level) {
                let types = ['TITAN', 'WIDOW', 'CORE', 'HIVE', 'PHANTOM', 'LANCER', 'HELIX'];
                this.name = types[Math.floor(Math.random() * types.length)];
                
                // Color & HP Init
                if(this.name === 'TITAN') { this.map = BOSS_1_MAP; this.c1 = '#ff3d00'; this.hp = 180; } 
                else if(this.name === 'WIDOW') { this.map = BOSS_2_MAP; this.c1 = '#76ff03'; this.hp = 140; } 
                else if(this.name === 'CORE') { this.map = BOSS_3_MAP; this.c1 = '#00e5ff'; this.hp = 160; }
                else if(this.name === 'HIVE') { this.map = BOSS_4_MAP; this.c1 = '#d500f9'; this.hp = 150; }
                else if(this.name === 'PHANTOM') { this.map = BOSS_5_MAP; this.c1 = '#536dfe'; this.hp = 130; }
                else if(this.name === 'LANCER') { this.map = BOSS_6_MAP; this.c1 = '#ffea00'; this.hp = 170; }
                else { this.map = BOSS_7_MAP; this.c1 = '#00bfa5'; this.hp = 150; }

                this.hp += (level * 25);
                this.scale = PIXEL_SCALE * 2;
                this.w = this.map[0].length * this.scale;
                this.h = this.map.length * this.scale;
                this.x = GAME_WIDTH/2 - this.w/2;
                this.y = -200;
                this.targetY = 100;
                this.maxHp = this.hp;
                this.state = 'ENTER';
                this.timer = 0;
            }
            
            update() {
                this.timer++;
                if(this.state === 'ENTER') {
                    this.y += 1.5;
                    if(this.y >= this.targetY) this.state = 'FIGHT';
                    return;
                }

                // AI PATTERNS
                if(this.name === 'TITAN') {
                    this.x += Math.sin(this.timer * 0.02) * 2;
                    if(this.timer % 100 === 0) this.shoot(0);
                }
                else if(this.name === 'WIDOW') {
                    this.x += Math.cos(this.timer * 0.05) * 5;
                    this.y = this.targetY + Math.sin(this.timer * 0.08) * 15;
                    if(this.timer % 60 === 0) this.shoot(1);
                }
                else if(this.name === 'CORE') {
                    if(this.timer % 110 === 0) this.shoot(2);
                }
                else if(this.name === 'HIVE') {
                    this.x = (GAME_WIDTH/2 - this.w/2) + Math.cos(this.timer * 0.03) * 100;
                    if(this.timer % 30 === 0) this.shoot(3);
                }
                else if(this.name === 'PHANTOM') { // Fast strafe
                    this.x += Math.sin(this.timer * 0.05) * 6;
                    if(this.timer % 40 === 0) this.shoot(4);
                }
                else if(this.name === 'LANCER') { // Vertical bob
                    this.y = this.targetY + Math.sin(this.timer * 0.05) * 40;
                    if(this.timer % 80 === 0) this.shoot(5);
                }
                else if(this.name === 'HELIX') { // Figure 8
                    this.x += Math.cos(this.timer * 0.03) * 3;
                    this.y = this.targetY + Math.sin(this.timer * 0.06) * 10;
                    if(this.timer % 50 === 0) this.shoot(6);
                }
            }

            shoot(type) {
                let bx = this.x + this.w/2;
                let by = this.y + this.h;
                
                if(type === 0) { // TITAN
                    entities.enemies.push(new BossProjectile(bx, by, 0, 4, 0));
                    entities.enemies.push(new BossProjectile(bx-30, by-10, -0.5, 3, 0));
                    entities.enemies.push(new BossProjectile(bx+30, by-10, 0.5, 3, 0));
                }
                else if(type === 1) { // WIDOW
                    let dx = entities.player.x - bx;
                    let vx = dx > 0 ? 3 : -3;
                    entities.enemies.push(new BossProjectile(bx, by, vx, 7, 1));
                }
                else if(type === 2) { // CORE
                    for(let i=0; i<8; i++) {
                        let angle = (i/8) * Math.PI * 2;
                        entities.enemies.push(new BossProjectile(bx, by+20, Math.cos(angle)*4, Math.sin(angle)*4, 2));
                    }
                }
                else if(type === 3) { // HIVE
                     entities.enemies.push(new BossProjectile(bx + (Math.random()*80-40), by, 0, 4, 3));
                }
                else if(type === 4) { // PHANTOM (Spread)
                    entities.enemies.push(new BossProjectile(bx, by, -2, 5, 4));
                    entities.enemies.push(new BossProjectile(bx, by, 2, 5, 4));
                }
                else if(type === 5) { // LANCER (Beam)
                    entities.enemies.push(new BossProjectile(bx, by, 0, 8, 5));
                }
                else if(type === 6) { // HELIX (Spiral)
                    let angle = (this.timer % 20) / 10;
                    entities.enemies.push(new BossProjectile(bx, by, Math.sin(angle)*3, 4, 6));
                }
            }

            draw() {
                drawSprite(this.map, this.x, this.y, this.c1, '#fff', this.scale);
            }
        }

        class Enemy {
            constructor() {
                this.type = Math.random() > 0.5 ? 1 : 2;
                this.map = this.type === 1 ? SPRITE_ENEMY_1 : SPRITE_ENEMY_2;
                this.w = 15 * PIXEL_SCALE;
                this.h = 9 * PIXEL_SCALE;
                this.x = Math.random() * (GAME_WIDTH - this.w);
                this.y = -50;
                this.speed = Math.random() * 2 + 2.5; 
                this.hp = this.type === 1 ? 2 : 1;
                this.dead = false;
                this.color = this.type === 1 ? '#ff3d00' : '#ff9100';
            }
            update() {
                this.y += this.speed;
                if(this.y > GAME_HEIGHT) this.dead = true;
            }
            draw() {
                drawSprite(this.map, this.x, this.y, this.color, '#fff');
            }
        }

        class Bullet {
            constructor(x, y) {
                this.x = x; this.y = y; this.w = 6; this.h = 24; this.dead = false;
            }
            update() {
                this.y -= 25;
                if(this.y < -20) this.dead = true;
            }
            draw() {
                ctx.fillStyle = '#00e5ff';
                ctx.fillRect(Math.floor(this.x), Math.floor(this.y), this.w+0.5, this.h+0.5);
            }
        }

        class BossProjectile {
            constructor(x, y, vx, vy, type) {
                this.x = x; this.y = y; this.vx = vx; this.vy = vy;
                this.type = type;
                this.dead = false;
                
                if(type === 0) { this.w = 12; this.h = 24; this.c = '#ff3d00'; }
                else if(type === 1) { this.w = 4; this.h = 16; this.c = '#76ff03'; }
                else if(type === 5) { this.w = 8; this.h = 30; this.c = '#ffea00'; } // Lancer beam
                else { this.w = 10; this.h = 10; this.c = '#00e5ff'; }
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if(this.type === 3 && entities.player) { // Homing
                    if(entities.player.x > this.x) this.vx += 0.2; else this.vx -= 0.2;
                    this.x += this.vx * 0.3; 
                }
                if(this.y > GAME_HEIGHT || this.y < -50 || this.x < -50 || this.x > GAME_WIDTH+50) this.dead = true;
            }
            draw() {
                ctx.fillStyle = this.c;
                if(this.type === 2 || this.type === 6) { 
                     ctx.beginPath(); ctx.arc(this.x+5, this.y+5, 5, 0, Math.PI*2); ctx.fill();
                } else {
                     ctx.fillRect(Math.floor(this.x), Math.floor(this.y), this.w+0.5, this.h+0.5);
                }
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.vx = (Math.random()-0.5) * 10;
                this.vy = (Math.random()-0.5) * 10;
                this.life = 1.0;
                this.color = color;
                this.size = Math.random() * 6 + 2;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.life -= 0.05;
            }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.fillRect(Math.floor(this.x), Math.floor(this.y), this.size, this.size);
                ctx.globalAlpha = 1;
            }
        }

        // --- GAME LOOP ---
        function checkCollisions() {
            let pBox = {x: entities.player.x+10, y: entities.player.y+10, w: entities.player.w-20, h: entities.player.h-20};

            entities.bullets.forEach(b => {
                entities.enemies.forEach(e => {
                    if(!b.dead && !e.dead && !(e instanceof BossProjectile)) {
                        if(b.x < e.x+e.w && b.x+b.w > e.x && b.y < e.y+e.h && b.y+b.h > e.y) {
                            b.dead = true; e.dead = true;
                            score += 50;
                            spawnParticles(e.x+e.w/2, e.y+e.h/2, e.color);
                        }
                    }
                });

                if(entities.boss && !b.dead) {
                    let boss = entities.boss;
                    if(b.x < boss.x+boss.w && b.x+b.w > boss.x && b.y < boss.y+boss.h && b.y+b.h > boss.y) {
                        b.dead = true;
                        if(boss.state === 'FIGHT') {
                            boss.hp--;
                            spawnParticles(b.x, b.y, '#fff', 1);
                            if(boss.hp <= 0) {
                                score += 5000;
                                screenShake = 20;
                                spawnParticles(boss.x+boss.w/2, boss.y+boss.h/2, boss.c1, 50);
                                entities.boss = null;
                                nextBossScore = score + 3000;
                                bossLevel++;
                            }
                        }
                    }
                }
            });

            entities.enemies.forEach(e => {
                let eBox = {x: e.x, y:e.y, w:e.w, h:e.h};
                if(e instanceof Enemy) { eBox = {x: e.x+5, y:e.y+5, w:e.w-10, h:e.h-10}; }
                
                if(!e.dead) {
                   if(pBox.x < eBox.x+eBox.w && pBox.x+pBox.w > eBox.x && pBox.y < eBox.y+eBox.h && pBox.y+pBox.h > eBox.y) {
                       screenShake = 15;
                       gameOver();
                   }
                }
            });

            if(entities.boss) {
                let boss = entities.boss;
                if(pBox.x < boss.x+boss.w-10 && pBox.x+pBox.w > boss.x+10 && pBox.y < boss.y+boss.h-10 && pBox.y+pBox.h > boss.y+10) {
                    screenShake = 15;
                    gameOver();
                }
            }
        }

        function spawnParticles(x, y, color, count=8) {
            for(let i=0; i<count; i++) entities.particles.push(new Particle(x, y, color));
        }

        function drawHud() {
            ctx.fillStyle = '#fff';
            ctx.font = '14px "Press Start 2P"';
            ctx.textAlign = 'left';
            ctx.fillText("SCORE:" + score, 10, 30);

            if(entities.boss) {
                let boss = entities.boss;
                let centerX = GAME_WIDTH/2;
                
                ctx.fillStyle = boss.c1;
                ctx.textAlign = 'center';
                ctx.fillText(boss.name, centerX, 50);

                let barW = 200;
                let barX = centerX - 100;
                let barY = 60;
                let fillPct = Math.max(0, boss.hp / boss.maxHp);
                
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                ctx.fillRect(barX, barY, barW, 6);
                
                ctx.fillStyle = boss.c1;
                ctx.fillRect(barX, barY, barW * fillPct, 6);
                
                ctx.textAlign = 'left'; 
            }
        }

        function loop() {
            if(gameState !== 'PLAYING') return;

            let dx = 0; let dy = 0;
            if(screenShake > 0) {
                dx = (Math.random()-0.5) * screenShake;
                dy = (Math.random()-0.5) * screenShake;
                screenShake *= 0.9;
                if(screenShake < 0.5) screenShake = 0;
            }

            ctx.save();
            ctx.translate(dx, dy);

            ctx.fillStyle = '#050505';
            ctx.fillRect(-10, -10, canvas.width+20, canvas.height+20);

            entities.stars.forEach(s => {
                s.y += s.speed + (entities.boss ? 4 : 0);
                if(s.y > GAME_HEIGHT) { s.y = 0; s.x = Math.random()*GAME_WIDTH; }
                ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
                ctx.fillRect(s.x, s.y, s.size, s.size);
            });

            entities.player.update();
            entities.player.draw();

            if(!entities.boss && score >= nextBossScore) {
                entities.boss = new Boss(bossLevel);
                entities.enemies = []; 
            }

            if(entities.boss) {
                entities.boss.update();
                entities.boss.draw();
            } else {
                if(frames % 45 === 0) entities.enemies.push(new Enemy());
            }

            entities.enemies.forEach(e => { e.update(); e.draw(); });
            entities.bullets.forEach(b => { b.update(); b.draw(); });
            entities.particles.forEach(p => { p.update(); p.draw(); });

            entities.enemies = entities.enemies.filter(e => !e.dead);
            entities.bullets = entities.bullets.filter(b => !b.dead);
            entities.particles = entities.particles.filter(p => p.life > 0);

            checkCollisions();
            drawHud();

            ctx.restore();

            frames++;
            requestAnimationFrame(loop);
        }

        function initGame() {
            score = 0;
            frames = 0;
            nextBossScore = 3000;
            bossLevel = 0;
            screenShake = 0;
            entities.player = new Player();
            entities.bullets = [];
            entities.enemies = [];
            entities.particles = [];
            entities.boss = null;
            
            gameState = 'PLAYING';
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            loop();
        }

        function gameOver() {
            gameState = 'GAMEOVER';
            document.getElementById('final-score').innerText = "SCORE: " + score;
            document.getElementById('game-over-screen').classList.add('active');
            spawnParticles(entities.player.x, entities.player.y, '#00e5ff', 30);
        }

        function showMainMenu() {
            gameState = 'MENU';
            document.getElementById('start-last-score').innerText = "LAST SCORE: " + score;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('start-screen').classList.add('active');
        }

        for(let i=0; i<80; i++) entities.stars.push({
            x:Math.random()*GAME_WIDTH, y:Math.random()*GAME_HEIGHT, size:Math.random()*2+1, speed:Math.random()*2+0.5, alpha: Math.random()
        });

    </script>
</body>
</html>